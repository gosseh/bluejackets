<!DOCTYPE html>
<html>
  <head>
    <title>Marker Animations</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCTujvwHxlUQq3MoQlAZJ1ps76sQSdCtI0&callback=initMap&libraries=&v=weekly"
      defer
    ></script>
    <style type="text/css">
      /* Set the size of the div element that contains the map */
      #map {
        height: 400px;
        /* The height is 400 pixels */
        width: 100%;
        /* The width is the width of the web page */
      }
    </style>
    <script>
	  let latitude = 42.280;
	  let longitude = -83.750;
	  if (typeof(Storage) !== "undefined") {
		if (localStorage.latitude && localStorage.longitude) {
	      latitude = parseFloat(localStorage.latitude);
		  longitude = parseFloat(localStorage.longitude);
		}
	  } else {
		alert("Cannot store location");
		// return to homepage
	  }
	  
	  function continueFunction() {
      window.location.href = './index.html';
	  }
	  
      // The following example creates a marker in Stockholm, Sweden using a DROP
      // animation. Clicking on the marker will toggle the animation between a BOUNCE
      // animation and no animation.
      let marker;

      function initMap() {
        const map = new google.maps.Map(document.getElementById("map"), {
          zoom: 13,
          center: { lat: 42.280, lng: -83.750 },
        });
        infoWindow = new google.maps.InfoWindow();
        const locationButton = document.createElement("button");
        locationButton.textContent = "Submit Current Location";
        locationButton.classList.add("custom-map-control-button");
        map.controls[google.maps.ControlPosition.TOP_CENTER].push(locationButton);
        var latitude;
        var longitude;
        locationButton.addEventListener("click", () => {
          // Try HTML5 geolocation.
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
            (position) => {
            marker = new google.maps.Marker({
              map,
              draggable: true,
              animation: google.maps.Animation.DROP,
              position: { lat: position.coords.latitude, lng: position.coords.longitude },
            });
            marker.addListener("drag", toggleBounce);
            marker.addListener("dragend", toggleBounce);
            let uid = firebase.auth().currentUser.uid;
              
            const pos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude,
            }
            firebase.database().ref().child('users/' + uid).push(pos)
            map.setCenter(pos);
          },
          () => {
            handleLocationError(true, infoWindow, map.getCenter());
          }
        );
      } else {
        // Browser doesn't support Geolocation
        handleLocationError(false, infoWindow, map.getCenter());
      }
    });


    }

    function handleLocationError(browserHasGeolocation, infoWindow, pos) {
    infoWindow.setPosition(pos);
    infoWindow.setContent(
      browserHasGeolocation
        ? "Error: The Geolocation service failed."
        : "Error: Your browser doesn't support geolocation."
    );
    infoWindow.open(map);
  }

      function toggleBounce() {
        if (marker.getAnimation() !== null) {
          marker.setAnimation(null);
        } else {
          marker.setAnimation(google.maps.Animation.BOUNCE);
        }
		
		latitude = parseFloat(marker.getPosition().lat());
		longitude = parseFloat(marker.getPosition().lng());
		console.log(latitude);
		console.log(longitude);
      }
    </script>
  </head>
  <body>
    <div class="navbar">
      <div class="header-title"> Bluejackets</div>
      <div class="header-description"> Find teammates for physical activities </div>
      <button id="filter"> 
          Filter 
          <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-chevron-compact-down" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
              <path fill-rule="evenodd" d="M1.553 6.776a.5.5 0 0 1 .67-.223L8 9.44l5.776-2.888a.5.5 0 1 1 .448.894l-6 3a.5.5 0 0 1-.448 0l-6-3a.5.5 0 0 1-.223-.67z"/>
            </svg>
      </button>
      <div id="weather"> Weather </div>
      <img src="images/cold.png" alt="weather-icon" id="weather-icon">
    </div>
    <div class="content-container">
      <h3>Please submit your location before continuing</h3>
      <div id="map"></div>
	    <button onclick="continueFunction()">Continue</button>
    </div>

      <!-- The core Firebase JS SDK is always required and must be listed first -->
      <script src="https://www.gstatic.com/firebasejs/8.1.1/firebase-app.js"></script>

      <!-- TODO: Add SDKs for Firebase products that you want to use
         https://firebase.google.com/docs/web/setup#available-libraries -->
      <script src="https://www.gstatic.com/firebasejs/8.1.1/firebase-auth.js"></script>
      <script src="https://www.gstatic.com/firebasejs/8.1.1/firebase-storage.js"></script>
      <script src="https://www.gstatic.com/firebasejs/8.1.1/firebase-database.js"></script>

    <script>
      // Your web app's Firebase configuration
      var firebaseConfig = {
          apiKey: "AIzaSyD1sxBkXEe4vtFoUEW82XmJZveU-72L9kA",
          authDomain: "eecs-493-bluejackets.firebaseapp.com",
          databaseURL: "https://eecs-493-bluejackets.firebaseio.com",
          projectId: "eecs-493-bluejackets",
          storageBucket: "eecs-493-bluejackets.appspot.com",
          messagingSenderId: "240250766842",
          appId: "1:240250766842:web:f81d88dcb31ac6dd4b5043"
      };
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      var database = firebase.database();
      </script>
  </body>
</html>